name: Electron Release

on:
  # æ¨ï¿½ï¿½ï¿½åˆ° prod åˆ†æ”¯æ—¶è‡ªåŠ¨è§¦å‘
  push:
    branches:
      - prod
      - release/major
      - release/minor
    tags:
      - 'v*'

  # æ‰‹åŠ¨è§¦å‘ï¼ˆå¯åœ¨ GitHub Actions é¡µé¢æ“ä½œï¼‰
  workflow_dispatch:
    inputs:
      version_type:
        description: 'ç‰ˆæœ¬æ›´æ–°ç±»å‹'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      draft:
        description: 'åˆ›å»ºä¸ºè‰ç¨¿ Release'
        required: false
        default: false
        type: boolean
      pre_release:
        description: 'æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  # ============================================
  # Job 1: ç‰ˆæœ¬ç®¡ç†ï¼ˆåªè¿è¡Œä¸€æ¬¡ï¼‰
  # ============================================
  version:
    name: Manage Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_type: ${{ steps.version_type.outputs.type }}
      is_draft: ${{ steps.release_config.outputs.draft }}
      is_pre_release: ${{ steps.release_config.outputs.pre_release }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: lts/*
          cache: 'pnpm'

      - name: Determine release config
        id: release_config
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "draft=${{ github.event.inputs.draft }}" >> $GITHUB_OUTPUT
            echo "pre_release=${{ github.event.inputs.pre_release }}" >> $GITHUB_OUTPUT
          else
            echo "draft=false" >> $GITHUB_OUTPUT
            echo "pre_release=false" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Determine version type
        id: version_type
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "type=${{ github.event.inputs.version_type }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/release/major" ]]; then
            echo "type=major" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/release/minor" ]]; then
            echo "type=minor" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "push" ]] && [[ "${{ github.ref }}" == "refs/tags/"* ]]; then
            echo "type=patch" >> $GITHUB_OUTPUT
          else
            # æ£€æŸ¥æœ€æ–°çš„ commit message
            LAST_MSG=$(git log -1 --pretty=%B)
            if [[ "$LAST_MSG" =~ chore\(release\):\ major ]]; then
              echo "type=major" >> $GITHUB_OUTPUT
            elif [[ "$LAST_MSG" =~ chore\(release\):\ minor ]]; then
              echo "type=minor" >> $GITHUB_OUTPUT
            else
              echo "type=patch" >> $GITHUB_OUTPUT
            fi
          fi
        shell: bash

      - name: Update version
        id: version
        run: |
          NEW_VERSION=$(node scripts/bump-version.js ${{ steps.version_type.outputs.type }})
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_ENV

          # è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯
          echo "### ğŸ“¦ Version Info" >> $GITHUB_STEP_SUMMARY
          echo "- **Type**: ${{ steps.version_type.outputs.type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: $NEW_VERSION" >> $GITHUB_STEP_SUMMARY
        shell: bash

      - name: Generate Release Notes
        id: release_notes
        run: |
          # è·å–ä¸Šä¸€ä¸ª tag
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          # ç”Ÿæˆ changelogï¼ˆæŒ‰ conventional commits åˆ†ç±»ï¼‰
          if [ -n "$PREV_TAG" ]; then
            # æå–å„ç±»åˆ«çš„æäº¤
            ALL_COMMITS=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s" --reverse)

            # æŒ‰ç±»å‹åˆ†ç±»
            FEAT_COMMITS=$(echo "$ALL_COMMITS" | grep "^- feat" | head -20)
            FIX_COMMITS=$(echo "$ALL_COMMITS" | grep "^- fix" | head -20)
            PERF_COMMITS=$(echo "$ALL_COMMITS" | grep "^- perf" | head -10)
            REFACTOR_COMMITS=$(echo "$ALL_COMMITS" | grep "^- refactor" | head -10)
            DOCS_COMMITS=$(echo "$ALL_COMMITS" | grep "^- docs" | head -10)
            CHORE_COMMITS=$(echo "$ALL_COMMITS" | grep "^- chore" | head -10)
            OTHER_COMMITS=$(echo "$ALL_COMMITS" | grep -v "^- \(feat\|fix\|perf\|refactor\|docs\|chore\)" | head -10)

            # æ„å»º release notes
            cat > ${{ github.workspace }}/release-notes.md << EOF
          ## ğŸ“¦ ç‰ˆæœ¬ ${{ env.new_version }}

          **å‘å¸ƒæ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ### âœ¨ æ–°åŠŸèƒ½
          ${FEAT_COMMITS:-æ— }

          ### ğŸ› Bug ä¿®å¤
          ${FIX_COMMITS:-æ— }

          ### âš¡ æ€§èƒ½ä¼˜åŒ–
          ${PERF_COMMITS:-æ— }

          ### â™»ï¸ ä»£ç é‡æ„
          ${REFACTOR_COMMITS:-æ— }

          ### ğŸ“ æ–‡æ¡£æ›´æ–°
          ${DOCS_COMMITS:-æ— }

          ### ğŸ”§ æ„å»º/å·¥å…·
          ${CHORE_COMMITS:-æ— }

          ### ğŸ“¦ å…¶ä»–å˜æ›´
          ${OTHER_COMMITS:-æ— }

          ### ğŸ“¥ ä¸‹è½½è¯´æ˜
          - **Windows**: ä¸‹è½½ `.exe` å®‰è£…ç¨‹åºï¼Œè¿è¡Œå®‰è£…
          EOF

            # è¾“å‡ºåˆ° summaryï¼ˆç®€åŒ–ç‰ˆï¼‰
            TOTAL_COMMITS=$(echo "$ALL_COMMITS" | wc -l)
            echo "### ğŸ“ Release Notes" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Commits**: $TOTAL_COMMITS" >> $GITHUB_STEP_SUMMARY
            echo "- **Features**: $(echo "$FEAT_COMMITS" | grep -c "^" || echo 0)" >> $GITHUB_STEP_SUMMARY
            echo "- **Fixes**: $(echo "$FIX_COMMITS" | grep -c "^" || echo 0)" >> $GITHUB_STEP_SUMMARY
          else
            cat > ${{ github.workspace }}/release-notes.md << EOF
          ## ğŸ“¦ ç‰ˆæœ¬ ${{ env.new_version }}

          **å‘å¸ƒæ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ### ğŸ‰ é¦–æ¬¡å‘å¸ƒ
          è¿™æ˜¯æ’åºç®—æ³•ç»¼åˆæ¼”ç¤ºç³»ç»Ÿçš„é¦–ä¸ªç‰ˆæœ¬ï¼

          ### ğŸ“¥ ä¸‹è½½è¯´æ˜
          - **Windows**: ä¸‹è½½ `.exe` å®‰è£…ç¨‹åºï¼Œè¿è¡Œå®‰è£…
          EOF

            echo "### ğŸ“ Release Notes" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ‰ é¦–æ¬¡å‘å¸ƒ" >> $GITHUB_STEP_SUMMARY
          fi
        shell: bash

      - name: Commit version update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # å…ˆæ‹‰å–æœ€æ–°è¿œç¨‹å˜æ›´
          git fetch origin ${{ github.ref_name }}
          git rebase origin/${{ github.ref_name }}

          # æäº¤ç‰ˆæœ¬æ›´æ–°
          git add package.json
          git commit -m "chore(release): bump version to ${{ env.new_version }}"

          # æ¨é€æäº¤
          git push origin HEAD:${{ github.ref_name }}
        shell: bash

      - name: Upload release notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: ${{ github.workspace }}/release-notes.md

  # ============================================
  # Job 2: æ„å»º Windows å¹³å°
  # ============================================
  build:
    name: Build Windows
    needs: version
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: lts/*
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Cache Electron binaries
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/electron
            ~/.cache/electron-builder
          key: ${{ runner.os }}-electron-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-electron-

      - name: Build
        run: npx cross-env BUILD_TARGET=electron pnpm run build
        shell: pwsh

      - name: Package for Windows
        run: |
          # Windows ä»£ç ç­¾åï¼ˆå¦‚æœæœ‰è¯ä¹¦ï¼‰
          if ($env:WIN_CERTIFICATE_BASE64) {
            Write-Output "ğŸ” è®¾ç½® Windows ä»£ç ç­¾å..."

            # å¯¼å…¥è¯ä¹¦
            $CERT_PATH = "$env:RUNNER_TEMP\cert.pfx"
            $env:WIN_CERTIFICATE_BASE64 | Out-File -Encoding Byte $CERT_PATH

            # å¯¼å…¥è¯ä¹¦åˆ° Windows è¯ä¹¦å­˜å‚¨
            $CERT_PASSWORD = ConvertTo-SecureString -String $env:WIN_CERTIFICATE_PASSWORD -Force -AsPlainText
            Import-PfxCertificate -FilePath $CERT_PATH -CertStoreLocation Cert:\LocalMachine\My -Password $CERT_PASSWORD

            # è®¾ç½®ç­¾åç¯å¢ƒå˜é‡
            $env:CSC_LINK = $CERT_PATH
            $env:CSC_KEY_PASSWORD = $env:WIN_CERTIFICATE_PASSWORD

            Write-Output "âœ… Windows ä»£ç ç­¾åé…ç½®å®Œæˆ"
          } else {
            Write-Output "âš ï¸  æœªé…ç½® Windows è¯ä¹¦ï¼Œè·³è¿‡ç­¾å"
          }

          npx electron-builder --win --publish never
        shell: pwsh
        env:
          WIN_CERTIFICATE_BASE64: ${{ secrets.WIN_CERTIFICATE_BASE64 }}
          WIN_CERTIFICATE_PASSWORD: ${{ secrets.WIN_CERTIFICATE_PASSWORD }}

      - name: Upload artifacts (Windows)
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ needs.version.outputs.version }}
          path: |
            release/*.exe
            release/*.zip
          retention-days: 30

  # ============================================
  # Job 3: åˆ›å»º Releaseï¼ˆä¾èµ–æ„å»ºå®Œæˆï¼‰
  # ============================================
  release:
    name: Create Release
    needs: [version, build]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download release notes
        uses: actions/download-artifact@v4
        with:
          name: release-notes
          path: ./

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Display structure
        run: |
          echo "Artifacts structure:"
          ls -R ./artifacts
          echo ""
          echo "Release notes:"
          cat release-notes.md

      - name: Create Git Tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # åˆ›å»º tag
          git tag "v${{ needs.version.outputs.version }}"

          # æ¨é€ tag
          git push origin "v${{ needs.version.outputs.version }}"

          echo "### ğŸ·ï¸  Tag Created" >> $GITHUB_STEP_SUMMARY
          echo "Tag: v${{ needs.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        shell: bash

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IS_DRAFT: ${{ needs.version.outputs.is_draft }}
          IS_PRERELEASE: ${{ needs.version.outputs.is_pre_release }}
        run: |
          # è¯»å– release notes
          RELEASE_NOTES=$(cat release-notes.md)

          # æ„å»º draft å’Œ prerelease å‚æ•°
          DRAFT_ARG=""
          if [ "$IS_DRAFT" = "true" ]; then
            DRAFT_ARG="--draft"
          fi

          PRERELEASE_ARG=""
          if [ "$IS_PRERELEASE" = "true" ]; then
            PRERELEASE_ARG="--prerelease"
          fi

          # åˆ›å»º release
          gh release create "v${{ needs.version.outputs.version }}" \
            --title "ğŸ“¦ ç‰ˆæœ¬ ${{ needs.version.outputs.version }}" \
            --notes "$RELEASE_NOTES" \
            $DRAFT_ARG \
            $PRERELEASE_ARG

          echo "âœ… Release created"
        shell: bash

      - name: Upload assets to Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # æ”¶é›†æ‰€æœ‰æ–‡ä»¶
          find ./artifacts -type f \( -name "*.exe" -o -name "*.zip" \) > upload_files.txt

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶
          if [ ! -s upload_files.txt ]; then
            echo "âš ï¸  No files found to upload"
            exit 0
          fi

          # ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶
          UPLOAD_COUNT=0
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              echo "Uploading: $file"
              gh release upload "v${{ needs.version.outputs.version }}" "$file"
              UPLOAD_COUNT=$((UPLOAD_COUNT + 1))
            fi
          done < upload_files.txt

          echo "âœ… Uploaded $UPLOAD_COUNT files"
        shell: bash

      - name: Update Release Summary
        run: |
          echo "### âœ… Release Created Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: v${{ needs.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Type**: ${{ needs.version.outputs.version_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Draft**: ${{ needs.version.outputs.is_draft }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Pre-release**: ${{ needs.version.outputs.is_pre_release }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”— [View Release](https://github.com/${{ github.repository }}/releases/tag/v${{ needs.version.outputs.version }})" >> $GITHUB_STEP_SUMMARY
        shell: bash
