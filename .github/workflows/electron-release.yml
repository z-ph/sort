name: Electron Release

on:
  # ä»…æ‰‹åŠ¨è§¦å‘ï¼ˆå¯åœ¨ GitHub Actions é¡µé¢æ“ä½œï¼‰
  workflow_dispatch:
    inputs:
      version_type:
        description: 'ç‰ˆæœ¬æ›´æ–°ç±»å‹'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      draft:
        description: 'åˆ›å»ºä¸ºè‰ç¨¿ Release'
        required: false
        default: false
        type: boolean
      pre_release:
        description: 'æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  # ============================================
  # Job 1: ç‰ˆæœ¬ç®¡ç†ï¼ˆåªè¿è¡Œä¸€æ¬¡ï¼‰
  # ============================================
  version:
    name: Manage Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_type: ${{ steps.version_type.outputs.type }}
      is_draft: ${{ steps.release_config.outputs.draft }}
      is_pre_release: ${{ steps.release_config.outputs.pre_release }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: lts/*
          cache: 'pnpm'

      - name: Determine release config
        id: release_config
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "draft=${{ github.event.inputs.draft }}" >> $GITHUB_OUTPUT
            echo "pre_release=${{ github.event.inputs.pre_release }}" >> $GITHUB_OUTPUT
          else
            echo "draft=false" >> $GITHUB_OUTPUT
            echo "pre_release=false" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Determine version type
        id: version_type
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "type=${{ github.event.inputs.version_type }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/release/major" ]]; then
            echo "type=major" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/release/minor" ]]; then
            echo "type=minor" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "push" ]] && [[ "${{ github.ref }}" == "refs/tags/"* ]]; then
            echo "type=patch" >> $GITHUB_OUTPUT
          else
            # æ£€æŸ¥æœ€æ–°çš„ commit message
            LAST_MSG=$(git log -1 --pretty=%B)
            if [[ "$LAST_MSG" =~ chore\(release\):\ major ]]; then
              echo "type=major" >> $GITHUB_OUTPUT
            elif [[ "$LAST_MSG" =~ chore\(release\):\ minor ]]; then
              echo "type=minor" >> $GITHUB_OUTPUT
            else
              echo "type=patch" >> $GITHUB_OUTPUT
            fi
          fi
        shell: bash

      - name: Update version
        id: version
        run: |
          NEW_VERSION=$(node scripts/bump-version.js ${{ steps.version_type.outputs.type }})
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_ENV

          # è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯
          echo "### ğŸ“¦ Version Info" >> $GITHUB_STEP_SUMMARY
          echo "- **Type**: ${{ steps.version_type.outputs.type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: $NEW_VERSION" >> $GITHUB_STEP_SUMMARY
        shell: bash

      - name: Get previous tag
        id: get_tag
        run: |
          # è·å–ä¸Šä¸€ä¸ª tag
          set +e
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null)
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -eq 0 ]; then
            echo "tag=$PREV_TAG" >> $GITHUB_OUTPUT
            echo "âœ… Found previous tag: $PREV_TAG"
          else
            echo "tag=" >> $GITHUB_OUTPUT
            echo "âš ï¸  No previous tag found (first release)"
          fi
        shell: bash

      - name: Generate commit log
        id: commit_log
        if: steps.get_tag.outputs.tag != ''
        run: |
          PREV_TAG="${{ steps.get_tag.outputs.tag }}"
          echo "ğŸ“ Generating commit log from $PREV_TAG to HEAD..."

          # è·å–æ‰€æœ‰æäº¤
          ALL_COMMITS=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s" --reverse)

          # ä¿å­˜åˆ°æ–‡ä»¶
          echo "$ALL_COMMITS" > ${{ github.workspace }}/all-commits.txt

          TOTAL_COUNT=$(echo "$ALL_COMMITS" | wc -l)
          echo "count=$TOTAL_COUNT" >> $GITHUB_OUTPUT
          echo "âœ… Found $TOTAL_COUNT commits"
        shell: bash

      - name: Categorize commits
        if: steps.get_tag.outputs.tag != ''
        run: |
          # è¯»å–æäº¤æ—¥å¿—
          ALL_COMMITS=$(cat ${{ github.workspace }}/all-commits.txt)

          # æŒ‰ç±»å‹åˆ†ç±»
          echo "ğŸ” Categorizing commits..."

          FEAT_COMMITS=$(echo "$ALL_COMMITS" | grep "^- feat" | head -20 || true)
          FIX_COMMITS=$(echo "$ALL_COMMITS" | grep "^- fix" | head -20 || true)
          PERF_COMMITS=$(echo "$ALL_COMMITS" | grep "^- perf" | head -10 || true)
          REFACTOR_COMMITS=$(echo "$ALL_COMMITS" | grep "^- refactor" | head -10 || true)
          DOCS_COMMITS=$(echo "$ALL_COMMITS" | grep "^- docs" | head -10 || true)
          CHORE_COMMITS=$(echo "$ALL_COMMITS" | grep "^- chore" | head -10 || true)
          OTHER_COMMITS=$(echo "$ALL_COMMITS" | grep -v "^- \(feat\|fix\|perf\|refactor\|docs\|chore\)" | head -10 || true)

          # ä¿å­˜åˆ†ç±»ç»“æœ
          echo "$FEAT_COMMITS" > ${{ github.workspace }}/feat-commits.txt
          echo "$FIX_COMMITS" > ${{ github.workspace }}/fix-commits.txt
          echo "$PERF_COMMITS" > ${{ github.workspace }}/perf-commits.txt
          echo "$REFACTOR_COMMITS" > ${{ github.workspace }}/refactor-commits.txt
          echo "$DOCS_COMMITS" > ${{ github.workspace }}/docs-commits.txt
          echo "$CHORE_COMMITS" > ${{ github.workspace }}/chore-commits.txt
          echo "$OTHER_COMMITS" > ${{ github.workspace }}/other-commits.txt

          # è¾“å‡ºç»Ÿè®¡
          echo "âœ… Features: $(echo "$FEAT_COMMITS" | grep -c "^" || echo 0)"
          echo "âœ… Fixes: $(echo "$FIX_COMMITS" | grep -c "^" || echo 0)"
        shell: bash

      - name: Build release notes (with history)
        if: steps.get_tag.outputs.tag != ''
        run: |
          # è¯»å–åˆ†ç±»ç»“æœ
          FEAT_COMMITS=$(cat ${{ github.workspace }}/feat-commits.txt)
          FIX_COMMITS=$(cat ${{ github.workspace }}/fix-commits.txt)
          PERF_COMMITS=$(cat ${{ github.workspace }}/perf-commits.txt)
          REFACTOR_COMMITS=$(cat ${{ github.workspace }}/refactor-commits.txt)
          DOCS_COMMITS=$(cat ${{ github.workspace }}/docs-commits.txt)
          CHORE_COMMITS=$(cat ${{ github.workspace }}/chore-commits.txt)
          OTHER_COMMITS=$(cat ${{ github.workspace }}/other-commits.txt)

          # æ„å»º release notes
          cat > ${{ github.workspace }}/release-notes.md << 'EOF'
          ## ğŸ“¦ ç‰ˆæœ¬ NEW_VERSION_PLACEHOLDER

          **å‘å¸ƒæ—¶é—´**: DATE_PLACEHOLDER

          ### âœ¨ æ–°åŠŸèƒ½
          FEAT_PLACEHOLDER

          ### ğŸ› Bug ä¿®å¤
          FIX_PLACEHOLDER

          ### âš¡ æ€§èƒ½ä¼˜åŒ–
          PERF_PLACEHOLDER

          ### â™»ï¸ ä»£ç é‡æ„
          REFACTOR_PLACEHOLDER

          ### ğŸ“ æ–‡æ¡£æ›´æ–°
          DOCS_PLACEHOLDER

          ### ğŸ”§ æ„å»º/å·¥å…·
          CHORE_PLACEHOLDER

          ### ğŸ“¦ å…¶ä»–å˜æ›´
          OTHER_PLACEHOLDER

          ### ğŸ“¥ ä¸‹è½½è¯´æ˜
          - **Windows**: ä¸‹è½½ `.exe` å®‰è£…ç¨‹åºï¼Œè¿è¡Œå®‰è£…
          EOF

          # æ›¿æ¢å ä½ç¬¦
          sed -i "s/NEW_VERSION_PLACEHOLDER/${{ env.new_version }}/" ${{ github.workspace }}/release-notes.md
          sed -i "s/DATE_PLACEHOLDER/$(date -u +"%Y-%m-%d %H:%M:%S UTC")/" ${{ github.workspace }}/release-notes.md
          sed -i "s|FEAT_PLACEHOLDER|${FEAT_COMMITS:-æ— }|" ${{ github.workspace }}/release-notes.md
          sed -i "s|FIX_PLACEHOLDER|${FIX_COMMITS:-æ— }|" ${{ github.workspace }}/release-notes.md
          sed -i "s|PERF_PLACEHOLDER|${PERF_COMMITS:-æ— }|" ${{ github.workspace }}/release-notes.md
          sed -i "s|REFACTOR_PLACEHOLDER|${REFACTOR_COMMITS:-æ— }|" ${{ github.workspace }}/release-notes.md
          sed -i "s|DOCS_PLACEHOLDER|${DOCS_COMMITS:-æ— }|" ${{ github.workspace }}/release-notes.md
          sed -i "s|CHORE_PLACEHOLDER|${CHORE_COMMITS:-æ— }|" ${{ github.workspace }}/release-notes.md
          sed -i "s|OTHER_PLACEHOLDER|${OTHER_COMMITS:-æ— }|" ${{ github.workspace }}/release-notes.md

          echo "âœ… Release notes created"
        shell: bash

      - name: Build release notes (first release)
        if: steps.get_tag.outputs.tag == ''
        run: |
          cat > ${{ github.workspace }}/release-notes.md << 'EOF'
          ## ğŸ“¦ ç‰ˆæœ¬ NEW_VERSION_PLACEHOLDER

          **å‘å¸ƒæ—¶é—´**: DATE_PLACEHOLDER

          ### ğŸ‰ é¦–æ¬¡å‘å¸ƒ
          è¿™æ˜¯æ’åºç®—æ³•ç»¼åˆæ¼”ç¤ºç³»ç»Ÿçš„é¦–ä¸ªç‰ˆæœ¬ï¼

          ### ğŸ“¥ ä¸‹è½½è¯´æ˜
          - **Windows**: ä¸‹è½½ `.exe` å®‰è£…ç¨‹åºï¼Œè¿è¡Œå®‰è£…
          EOF

          # æ›¿æ¢å ä½ç¬¦
          sed -i "s/NEW_VERSION_PLACEHOLDER/${{ env.new_version }}/" ${{ github.workspace }}/release-notes.md
          sed -i "s/DATE_PLACEHOLDER/$(date -u +"%Y-%m-%d %H:%M:%S UTC")/" ${{ github.workspace }}/release-notes.md

          echo "âœ… First release notes created"
        shell: bash

      - name: Generate release summary
        run: |
          echo "### ğŸ“ Release Notes Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -n "${{ steps.get_tag.outputs.tag }}" ]; then
            TOTAL_COUNT=${{ steps.commit_log.outputs.count }}
            FEAT_COUNT=$(cat ${{ github.workspace }}/feat-commits.txt | grep -c "^" || echo 0)
            FIX_COUNT=$(cat ${{ github.workspace }}/fix-commits.txt | grep -c "^" || echo 0)

            echo "- **Previous Tag**: ${{ steps.get_tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Commits**: $TOTAL_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "- **Features**: $FEAT_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "- **Fixes**: $FIX_COUNT" >> $GITHUB_STEP_SUMMARY
          else
            echo "ğŸ‰ **First Release**" >> $GITHUB_STEP_SUMMARY
          fi
        shell: bash

      - name: Commit version update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # å…ˆæ‹‰å–æœ€æ–°è¿œç¨‹å˜æ›´
          git fetch origin ${{ github.ref_name }}
          git rebase origin/${{ github.ref_name }}

          # æäº¤ç‰ˆæœ¬æ›´æ–°
          git add package.json
          git commit -m "chore(release): bump version to ${{ env.new_version }}"

          # æ¨é€æï¿½ï¿½
          git push origin HEAD:${{ github.ref_name }}
        shell: bash

      - name: Upload release notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: ${{ github.workspace }}/release-notes.md

  # ============================================
  # Job 2: æ„å»º Windows å¹³å°
  # ============================================
  build:
    name: Build Windows
    needs: version
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: lts/*
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Cache Electron binaries
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/electron
            ~/.cache/electron-builder
          key: ${{ runner.os }}-electron-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-electron-

      - name: Build
        run: npx cross-env BUILD_TARGET=electron pnpm run build
        shell: pwsh

      - name: Package for Windows
        run: |
          # Windows ä»£ç ç­¾åï¼ˆå¦‚æœæœ‰è¯ä¹¦ï¼‰
          if ($env:WIN_CERTIFICATE_BASE64) {
            Write-Output "ğŸ” è®¾ç½® Windows ä»£ç ç­¾å..."

            # å¯¼å…¥è¯ä¹¦
            $CERT_PATH = "$env:RUNNER_TEMP\cert.pfx"
            $env:WIN_CERTIFICATE_BASE64 | Out-File -Encoding Byte $CERT_PATH

            # å¯¼å…¥è¯ä¹¦åˆ° Windows è¯ä¹¦å­˜å‚¨
            $CERT_PASSWORD = ConvertTo-SecureString -String $env:WIN_CERTIFICATE_PASSWORD -Force -AsPlainText
            Import-PfxCertificate -FilePath $CERT_PATH -CertStoreLocation Cert:\LocalMachine\My -Password $CERT_PASSWORD

            # è®¾ç½®ç­¾åç¯å¢ƒå˜é‡
            $env:CSC_LINK = $CERT_PATH
            $env:CSC_KEY_PASSWORD = $env:WIN_CERTIFICATE_PASSWORD

            Write-Output "âœ… Windows ä»£ç ç­¾åé…ç½®å®Œæˆ"
          } else {
            Write-Output "âš ï¸  æœªé…ç½® Windows è¯ä¹¦ï¼Œè·³è¿‡ç­¾å"
          }

          npx electron-builder --win --publish never
        shell: pwsh
        env:
          WIN_CERTIFICATE_BASE64: ${{ secrets.WIN_CERTIFICATE_BASE64 }}
          WIN_CERTIFICATE_PASSWORD: ${{ secrets.WIN_CERTIFICATE_PASSWORD }}

      - name: Upload artifacts (Windows)
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ needs.version.outputs.version }}
          path: |
            release/*.exe
            release/*.zip
          retention-days: 30

  # ============================================
  # Job 3: åˆ›å»º Releaseï¼ˆä¾èµ–æ„å»ºå®Œæˆï¼‰
  # ============================================
  release:
    name: Create Release
    needs: [version, build]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download release notes
        uses: actions/download-artifact@v4
        with:
          name: release-notes
          path: ./

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Display structure
        run: |
          echo "Artifacts structure:"
          ls -R ./artifacts
          echo ""
          echo "Release notes:"
          cat release-notes.md

      - name: Create Git Tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # å…ˆæ‹‰å–è¿œç¨‹ tags
          git fetch origin +refs/tags/*:refs/tags/*

          TAG_NAME="v${{ needs.version.outputs.version }}"

          # å¦‚æœ tag å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "Tag $TAG_NAME already exists, deleting..."
            git tag -d "$TAG_NAME"
            git push origin ":refs/tags/$TAG_NAME" || true
          fi

          # åˆ›å»º tag
          git tag "$TAG_NAME"

          # æ¨é€ tag
          git push origin "$TAG_NAME"

          echo "### ğŸ·ï¸  Tag Created" >> $GITHUB_STEP_SUMMARY
          echo "Tag: $TAG_NAME" >> $GITHUB_STEP_SUMMARY
        shell: bash

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IS_DRAFT: ${{ needs.version.outputs.is_draft }}
          IS_PRERELEASE: ${{ needs.version.outputs.is_pre_release }}
        run: |
          # è¯»å– release notes
          RELEASE_NOTES=$(cat release-notes.md)

          # æ„å»º draft å’Œ prerelease å‚æ•°
          DRAFT_ARG=""
          if [ "$IS_DRAFT" = "true" ]; then
            DRAFT_ARG="--draft"
          fi

          PRERELEASE_ARG=""
          if [ "$IS_PRERELEASE" = "true" ]; then
            PRERELEASE_ARG="--prerelease"
          fi

          # åˆ›å»º release
          gh release create "v${{ needs.version.outputs.version }}" \
            --title "ğŸ“¦ ç‰ˆæœ¬ ${{ needs.version.outputs.version }}" \
            --notes "$RELEASE_NOTES" \
            $DRAFT_ARG \
            $PRERELEASE_ARG

          echo "âœ… Release created"
        shell: bash

      - name: Upload assets to Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # æ”¶é›†æ‰€æœ‰æ–‡ä»¶
          find ./artifacts -type f \( -name "*.exe" -o -name "*.zip" \) > upload_files.txt

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶
          if [ ! -s upload_files.txt ]; then
            echo "âš ï¸  No files found to upload"
            exit 0
          fi

          # ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶
          UPLOAD_COUNT=0
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              echo "Uploading: $file"
              gh release upload "v${{ needs.version.outputs.version }}" "$file"
              UPLOAD_COUNT=$((UPLOAD_COUNT + 1))
            fi
          done < upload_files.txt

          echo "âœ… Uploaded $UPLOAD_COUNT files"
        shell: bash

      - name: Update Release Summary
        run: |
          echo "### âœ… Release Created Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: v${{ needs.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Type**: ${{ needs.version.outputs.version_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Draft**: ${{ needs.version.outputs.is_draft }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Pre-release**: ${{ needs.version.outputs.is_pre_release }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”— [View Release](https://github.com/${{ github.repository }}/releases/tag/v${{ needs.version.outputs.version }})" >> $GITHUB_STEP_SUMMARY
        shell: bash
